-- Script untuk mengambil posisi setiap perpindahan dan mengirim ke Telegram Bot
-- Position tracker and Telegram sender with Rayfield UI

local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

-- Load Rayfield UI Library
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Konfigurasi Telegram Bot
local TELEGRAM_BOT_TOKEN = "8299595872:AAG9ts0PzEnagQGbYPtUa2vDseqjvL5pi2w" -- Token bot Telegram Anda
local TELEGRAM_CHAT_ID = "1222630961" -- Ganti dengan chat ID Anda

-- Variabel untuk tracking posisi
local player = Players.LocalPlayer
local character = player.CharacterAdded:Wait()
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")

local positionData = {
    playerName = player.Name,
    positions = {},
    startTime = os.time(),
    totalMovements = 0
}

local lastPosition = humanoidRootPart.Position
local positionThreshold = 5 -- Minimum jarak perpindahan untuk dianggap sebagai movement (studs)
local sendInterval = 30 -- Interval pengiriman ke Telegram (detik)
local lastSendTime = os.time()

-- Variabel kontrol
local isTracking = false
local connection = nil

-- Fungsi untuk mengirim data ke Telegram
local function sendToTelegram(message)
    local url = "https://api.telegram.org/bot" .. TELEGRAM_BOT_TOKEN .. "/sendMessage"
    local data = {
        chat_id = TELEGRAM_CHAT_ID,
        text = message,
        parse_mode = "Markdown"
    }
    
    local success, response = pcall(function()
        return HttpService:PostAsync(url, HttpService:JSONEncode(data), Enum.HttpContentType.ApplicationJson)
    end)
    
    if success then
        print("‚úÖ Data berhasil dikirim ke Telegram")
        return true
    else
        warn("‚ùå Gagal mengirim ke Telegram: " .. tostring(response))
        return false
    end
end

-- Fungsi untuk format posisi
local function formatPosition(pos)
    return string.format("X: %.2f, Y: %.2f, Z: %.2f", pos.X, pos.Y, pos.Z)
end

-- Fungsi untuk menghitung jarak
local function getDistance(pos1, pos2)
    return (pos1 - pos2).Magnitude
end

-- Fungsi untuk membuat pesan Telegram
local function createTelegramMessage()
    local message = "üéÆ *Roblox Position Tracker*\n\n"
    message = message .. "üë§ *Player:* " .. positionData.playerName .. "\n"
    message = message .. "üìä *Total Movements:* " .. positionData.totalMovements .. "\n"
    message = message .. "‚è∞ *Session Start:* " .. os.date("%H:%M:%S", positionData.startTime) .. "\n\n"
    
    if #positionData.positions > 0 then
        message = message .. "üìç *Recent Positions:*\n"
        
        -- Tampilkan 10 posisi terakhir
        local startIndex = math.max(1, #positionData.positions - 9)
        for i = startIndex, #positionData.positions do
            local pos = positionData.positions[i]
            message = message .. string.format("‚Ä¢ %s - %s\n", 
                os.date("%H:%M:%S", pos.timestamp), 
                formatPosition(pos.position)
            )
        end
        
        if #positionData.positions > 10 then
            message = message .. "\nüìù *(" .. (#positionData.positions - 10) .. " posisi lainnya tersimpan)*"
        end
    else
        message = message .. "üìç *No movements recorded yet*"
    end
    
    return message
end

-- Fungsi untuk menambah posisi baru
local function addPosition(newPosition)
    local positionEntry = {
        position = newPosition,
        timestamp = os.time(),
        distance = getDistance(newPosition, lastPosition)
    }
    
    table.insert(positionData.positions, positionEntry)
    positionData.totalMovements = positionData.totalMovements + 1
    lastPosition = newPosition
    
    print(string.format("üìç Movement #%d: %s (Distance: %.2f studs)", 
        positionData.totalMovements, 
        formatPosition(newPosition),
        positionEntry.distance
    ))
end

-- Fungsi untuk mengirim data secara berkala
local function sendPeriodicUpdate()
    local currentTime = os.time()
    if currentTime - lastSendTime >= sendInterval then
        if positionData.totalMovements > 0 then
            local message = createTelegramMessage()
            sendToTelegram(message)
        end
        lastSendTime = currentTime
    end
end

-- Event handler untuk character respawn
local function onCharacterAdded(newCharacter)
    character = newCharacter
    humanoidRootPart = character:WaitForChild("HumanoidRootPart")
    lastPosition = humanoidRootPart.Position
    
    print("üîÑ Character respawned, position tracking resumed")
end

-- Setup event listeners
player.CharacterAdded:Connect(onCharacterAdded)

-- Fungsi untuk memulai tracking
local function startTracking()
    if not isTracking then
        isTracking = true
        connection = RunService.Heartbeat:Connect(function()
            if character and humanoidRootPart and humanoidRootPart.Parent then
                local currentPosition = humanoidRootPart.Position
                local distance = getDistance(currentPosition, lastPosition)
                
                -- Cek apakah player sudah bergerak cukup jauh
                if distance >= positionThreshold then
                    addPosition(currentPosition)
                end
                
                -- Kirim update berkala
                sendPeriodicUpdate()
            end
        end)
        print("‚ñ∂Ô∏è Position tracking started")
        updateStatusLabel()
    end
end

-- Fungsi untuk menghentikan tracking
local function stopTracking()
    if isTracking and connection then
        isTracking = false
        connection:Disconnect()
        connection = nil
        print("‚èπÔ∏è Position tracking stopped")
        updateStatusLabel()
    end
end

-- Fungsi untuk reset data
local function resetData()
    stopTracking()
    clearPositionData()
    print("üîÑ Data reset and tracking stopped")
    updateStatusLabel()
end

-- Fungsi untuk mengirim data manual
local function sendManualUpdate()
    local message = createTelegramMessage()
    return sendToTelegram(message)
end

-- Fungsi untuk clear data posisi
local function clearPositionData()
    positionData.positions = {}
    positionData.totalMovements = 0
    positionData.startTime = os.time()
    print("üóëÔ∏è Position data cleared")
end

-- Variabel untuk Rayfield UI
local Window = nil
local statusLabel = nil
local Tab = nil

-- Membuat Rayfield UI
local function createRayfieldGUI()
    -- Create Main Window
    Window = Rayfield:CreateWindow({
        Name = "üéÆ Position Tracker",
        LoadingTitle = "Position Tracker",
        LoadingSubtitle = "by Canks69",
        Theme = "Ocean", -- Ocean, DarkBlue, Amethyst, etc.
        DisableRayfieldPrompts = false,
        DisableBuildWarnings = false,
        ConfigurationSaving = {
            Enabled = true,
            FolderName = "PositionTracker",
            FileName = "config"
        },
        Discord = {
            Enabled = false
        },
        KeySystem = false
    })
    
    -- Create Main Tab
    Tab = Window:CreateTab("üéØ Main Controls", 4483362458)
    
    -- Status Section
    Tab:CreateSection("üìä Status Information")
    
    statusLabel = Tab:CreateLabel("‚èπÔ∏è Status: Stopped | Movements: 0 | Positions: 0")
    
    -- Settings Section  
    Tab:CreateSection("‚öôÔ∏è Settings")
    
    local thresholdSlider = Tab:CreateSlider({
        Name = "üìè Movement Threshold (studs)",
        Range = {1, 20},
        Increment = 1,
        Suffix = " studs",
        CurrentValue = positionThreshold,
        Flag = "ThresholdSlider",
        Callback = function(Value)
            positionThreshold = Value
            print("üìè Movement threshold set to: " .. Value .. " studs")
        end,
    })
    
    local intervalSlider = Tab:CreateSlider({
        Name = "‚è±Ô∏è Send Interval (seconds)",
        Range = {10, 300},
        Increment = 10,
        Suffix = " sec",
        CurrentValue = sendInterval,
        Flag = "IntervalSlider", 
        Callback = function(Value)
            sendInterval = Value
            print("‚è±Ô∏è Send interval set to: " .. Value .. " seconds")
        end,
    })
    
    -- Control Section
    Tab:CreateSection("üéÆ Controls")
    
    -- Start/Stop Toggle
    local trackingToggle = Tab:CreateToggle({
        Name = "‚ñ∂Ô∏è Start Position Tracking",
        CurrentValue = false,
        Flag = "TrackingToggle",
        Callback = function(Value)
            if Value then
                startTracking()
            else
                stopTracking()
            end
        end,
    })
    
    -- Control Buttons
    local playButton = Tab:CreateButton({
        Name = "‚ñ∂Ô∏è Start Tracking",
        Callback = function()
            startTracking()
            trackingToggle:Set(true)
        end,
    })
    
    local stopButton = Tab:CreateButton({
        Name = "‚èπÔ∏è Stop Tracking", 
        Callback = function()
            stopTracking()
            trackingToggle:Set(false)
        end,
    })
    
    local resetButton = Tab:CreateButton({
        Name = "üîÑ Reset Data",
        Callback = function()
            resetData()
            trackingToggle:Set(false)
            Rayfield:Notify({
                Title = "Data Reset",
                Content = "All position data has been cleared!",
                Duration = 3,
                Image = 4483362458,
            })
        end,
    })
    
    local sendButton = Tab:CreateButton({
        Name = "üì§ Send to Telegram",
        Callback = function()
            local success = sendManualUpdate()
            if success then
                Rayfield:Notify({
                    Title = "Message Sent",
                    Content = "Position data sent to Telegram successfully!",
                    Duration = 3,
                    Image = 4483362458,
                })
            else
                Rayfield:Notify({
                    Title = "Send Failed",
                    Content = "Failed to send message to Telegram!",
                    Duration = 5,
                    Image = 4483362458,
                })
            end
        end,
    })
    
    -- Information Tab
    local InfoTab = Window:CreateTab("üìä Information", 4483362458)
    
    InfoTab:CreateSection("üìà Session Statistics")
    
    local movementsLabel = InfoTab:CreateLabel("üìç Total Movements: 0")
    local positionsLabel = InfoTab:CreateLabel("üìä Positions Recorded: 0") 
    local sessionLabel = InfoTab:CreateLabel("‚è∞ Session Started: " .. os.date("%H:%M:%S"))
    local lastPosLabel = InfoTab:CreateLabel("üìç Last Position: Not available")
    
    InfoTab:CreateSection("‚öôÔ∏è Current Settings")
    
    local thresholdInfo = InfoTab:CreateLabel("üìè Movement Threshold: " .. positionThreshold .. " studs")
    local intervalInfo = InfoTab:CreateLabel("‚è±Ô∏è Send Interval: " .. sendInterval .. " seconds")
    local botInfo = InfoTab:CreateLabel("ü§ñ Bot Status: Connected")
    
    -- Telegram Tab
    local TelegramTab = Window:CreateTab("üì± Telegram", 4483362458)
    
    TelegramTab:CreateSection("ü§ñ Bot Configuration")
    
    TelegramTab:CreateLabel("üÜî Bot Token: " .. TELEGRAM_BOT_TOKEN:sub(1, 20) .. "...")
    TelegramTab:CreateLabel("üí¨ Chat ID: " .. TELEGRAM_CHAT_ID)
    
    local testButton = TelegramTab:CreateButton({
        Name = "üß™ Test Bot Connection",
        Callback = function()
            local testSuccess = sendToTelegram("üß™ *Test Message*\n\n‚úÖ Bot connection is working!\nüìÖ " .. os.date("%Y-%m-%d %H:%M:%S"))
            if testSuccess then
                Rayfield:Notify({
                    Title = "Test Successful",
                    Content = "Test message sent to Telegram!",
                    Duration = 3,
                    Image = 4483362458,
                })
            else
                Rayfield:Notify({
                    Title = "Test Failed", 
                    Content = "Failed to send test message!",
                    Duration = 5,
                    Image = 4483362458,
                })
            end
        end,
    })
    
    TelegramTab:CreateSection("üìã Message Preview")
    
    local previewButton = TelegramTab:CreateButton({
        Name = "üëÅÔ∏è Preview Message Format",
        Callback = function()
            local previewMessage = createTelegramMessage()
            print("üìã Message Preview:")
            print(previewMessage)
            Rayfield:Notify({
                Title = "Preview Generated",
                Content = "Check console for message preview!",
                Duration = 3,
                Image = 4483362458,
            })
        end,
    })
    
    -- Advanced Tab
    local AdvancedTab = Window:CreateTab("‚öôÔ∏è Advanced", 4483362458)
    
    AdvancedTab:CreateSection("üé® UI Theme")
    
    local themeDropdown = AdvancedTab:CreateDropdown({
        Name = "Select UI Theme",
        Options = {"Ocean", "DarkBlue", "Amethyst", "Green", "Light"},
        CurrentOption = "Ocean",
        Flag = "ThemeDropdown",
        Callback = function(Option)
            -- Note: Theme change requires UI reload
            Rayfield:Notify({
                Title = "Theme Changed",
                Content = "Restart script to apply " .. Option .. " theme!",
                Duration = 5,
                Image = 4483362458,
            })
        end,
    })
    
    AdvancedTab:CreateSection("üîß Advanced Settings")
    
    local debugToggle = AdvancedTab:CreateToggle({
        Name = "üêõ Debug Mode",
        CurrentValue = false,
        Flag = "DebugToggle",
        Callback = function(Value)
            if Value then
                print("üêõ Debug mode enabled")
            else
                print("üêõ Debug mode disabled")  
            end
        end,
    })
    
    local autoSendToggle = AdvancedTab:CreateToggle({
        Name = "üì§ Auto Send to Telegram",
        CurrentValue = true,
        Flag = "AutoSendToggle",
        Callback = function(Value)
            if Value then
                print("üì§ Auto send enabled")
            else
                print("üì§ Auto send disabled")
            end
        end,
    })
    
    AdvancedTab:CreateSection("üìä Export Data")
    
    local exportButton = AdvancedTab:CreateButton({
        Name = "üíæ Export Position Data",
        Callback = function()
            local exportData = "Position Data Export\n"
            exportData = exportData .. "Player: " .. positionData.playerName .. "\n"
            exportData = exportData .. "Total Movements: " .. positionData.totalMovements .. "\n"
            exportData = exportData .. "Session Start: " .. os.date("%Y-%m-%d %H:%M:%S", positionData.startTime) .. "\n\n"
            exportData = exportData .. "Positions:\n"
            
            for i, pos in ipairs(positionData.positions) do
                exportData = exportData .. string.format("%d. %s - %s (Distance: %.2f)\n", 
                    i, 
                    os.date("%H:%M:%S", pos.timestamp),
                    formatPosition(pos.position),
                    pos.distance
                )
            end
            
            print("üíæ POSITION DATA EXPORT:")
            print(exportData)
            
            Rayfield:Notify({
                Title = "Data Exported",
                Content = "Check console for exported position data!",
                Duration = 3,
                Image = 4483362458,
            })
        end,
    })
    
    local clearAllButton = AdvancedTab:CreateButton({
        Name = "üóëÔ∏è Clear All Data & Reset",
        Callback = function()
            resetData()
            Rayfield:Notify({
                Title = "Complete Reset",
                Content = "All data cleared and tracking stopped!",
                Duration = 3,
                Image = 4483362458,
            })
        end,
    })
    
    -- Fungsi untuk update status label
    function updateStatusLabel()
        local statusText = ""
        if isTracking then
            statusText = "‚ñ∂Ô∏è Status: Tracking"
        else
            statusText = "‚èπÔ∏è Status: Stopped"
        end
        
        statusText = statusText .. " | Movements: " .. positionData.totalMovements .. " | Positions: " .. #positionData.positions
        
        if statusLabel then
            statusLabel:Set(statusText)
        end
        
        -- Update information tab labels
        if movementsLabel then movementsLabel:Set("üìç Total Movements: " .. positionData.totalMovements) end
        if positionsLabel then positionsLabel:Set("üìä Positions Recorded: " .. #positionData.positions) end
        if sessionLabel then sessionLabel:Set("‚è∞ Session Started: " .. os.date("%H:%M:%S", positionData.startTime)) end
        if lastPosLabel and humanoidRootPart then 
            lastPosLabel:Set("üìç Last Position: " .. formatPosition(humanoidRootPart.Position))
        end
        if thresholdInfo then thresholdInfo:Set("üìè Movement Threshold: " .. positionThreshold .. " studs") end
        if intervalInfo then intervalInfo:Set("‚è±Ô∏è Send Interval: " .. sendInterval .. " seconds") end
    end
    
    -- Update status setiap detik
    spawn(function()
        while Window do
            updateStatusLabel()
            wait(1)
        end
    end)
    
    -- Initial status update
    updateStatusLabel()
    
    print("üéÆ Rayfield Position Tracker GUI loaded successfully!")
end

-- Fungsi untuk membuat updateStatusLabel global (fallback)
function updateStatusLabel()
    -- This will be overridden by the Rayfield GUI function
end


-- Commands untuk kontrol manual (backup)
game.Players.LocalPlayer.Chatted:Connect(function(message)
    if message:lower() == "/sendpos" then
        sendManualUpdate()
    elseif message:lower() == "/clearpos" then
        resetData()
    elseif message:lower() == "/posinfo" then
        print("üìä Total Movements: " .. positionData.totalMovements)
        print("üìç Positions Recorded: " .. #positionData.positions)
        print("‚è∞ Session Start: " .. os.date("%H:%M:%S", positionData.startTime))
    elseif message:lower() == "/play" then
        startTracking()
    elseif message:lower() == "/stop" then
        stopTracking()
    elseif message:lower() == "/gui" then
        createRayfieldGUI()
    end
end)

-- Cleanup saat script dihentikan
game:BindToClose(function()
    if connection then
        connection:Disconnect()
    end
    
    -- Kirim data terakhir sebelum keluar
    if positionData.totalMovements > 0 then
        local finalMessage = "üî¥ *Session Ended*\n\n" .. createTelegramMessage()
        sendToTelegram(finalMessage)
    end
end)

-- Fungsi untuk membuat updateStatusLabel global (fallback)
function updateStatusLabel()
    -- This will be overridden by the Rayfield GUI function
end

-- Startup
print("üöÄ Position Tracker with Rayfield UI Started!")
print("üí¨ Commands: /play, /stop, /sendpos, /clearpos, /posinfo, /gui")
print("üéÆ Loading Rayfield UI...")

-- Kirim pesan startup ke Telegram
local startupMessage = "üöÄ *Position Tracker Started*\n\n" ..
                      "üë§ Player: " .. player.Name .. "\n" ..
                      "‚è∞ Started at: " .. os.date("%H:%M:%S") .. "\n" ..
                      "üìè Movement threshold: " .. positionThreshold .. " studs\n" ..
                      "‚è±Ô∏è Send interval: " .. sendInterval .. " seconds\n" ..
                      "üéÆ UI: Rayfield Professional Interface"

sendToTelegram(startupMessage)

-- Auto-create Rayfield GUI setelah 2 detik
wait(2)
createRayfieldGUI()